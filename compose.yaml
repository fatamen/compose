name: "finalproj"

services:
  java:
    build:
      context: ./back
      dockerfile: ./tomcat.dockerfile
      args:
        war_file: GoldenBowl.war
    container_name: goldenBowl-back
    ports:
      - "9080:8080" # Java 服務的端口映射，通常用於內部調試或直接訪問，Nginx 不會用到這個主機端口
    depends_on:
      - sqlserver # 確保 SQL Server 在 Java 服務之前啟動
    environment:
      # ***關鍵修改：讓 Java 連接到 Docker 網絡中的 SQL Server 服務名稱***
      # 這是最推薦的做法，因為服務之間使用 Docker 內網溝通
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://sqlserver:1433;database=back2;trustServerCertificate=true
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=P@ssw0rd

  vue1: # Nginx 服務 (主前端)
    build:
      context: ./front-cus
      dockerfile: ./nginx.dockerfile
      args:
        config_file: nginx.conf
        publish_dir: dist
    container_name: vue-cus
    depends_on:
      - java
    environment:
      - TZ=Asia/Taipei
    ports:
      - "80:80"     # 主機的 80 端口映射到容器的 80 端口 (用於 HTTP 重定向)
      - "443:443"   # 主機的 443 端口映射到容器的 443 端口 (用於 HTTPS 訪問)
      - "6173:6173" # 你原有的開發或特定用途端口，如果不需要外部訪問可以移除

  vue2: # Nginx 服務 (商店前端)
    build:
      context: ./front-store
      dockerfile: ./nginx.dockerfile
      args:
        config_file: nginx.conf
        publish_dir: dist
    container_name: vue-store
    depends_on:
      - java
    environment:
      - TZ=Asia/Taipei
    ports:
      - "8081:80"   # HTTP 端口
      - "8443:443"  # HTTPS 端口映射 (主機 8443 -> 容器 443)
      - "7173:6173"

  vue3: # Nginx 服務 (管理前端)
    build:
      context: ./front-admin
      dockerfile: ./nginx.dockerfile
      args:
        config_file: nginx.conf
        publish_dir: dist
    container_name: vue-admin
    depends_on:
      - java
    environment:
      - TZ=Asia/Taipei
    ports:
      - "8082:80"   # HTTP 端口
      - "8444:443"  # HTTPS 端口映射 (主機 8444 -> 容器 443)
      - "9174:6173"

  # =========================================================
  # SQL Server 服務配置
  # =========================================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver-back
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=P@ssw0rd
      - MSSQL_COLLATION=Chinese_Taiwan_Stroke_CI_AS
      - TZ=Asia/Taipei
    ports:
      - "9433:1433" # 主機的 9433 端口映射到容器內 SQL Server 的 1433 端口
                    # 這是給主機或其他不在 Docker Compose 網絡的程式直接連線用
    volumes:
      - mssqlsystem:/var/opt/mssql
      - mssqluser:/var/opt/sqlserver

volumes:
  mssqlsystem:
  mssqluser: